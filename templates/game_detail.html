<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Game Details</title>
    <script>
        async function loadGameDetails() {
            let gameName = window.location.pathname.split('/').pop();
            let response = await fetch(`/game_details/${gameName}`);
            let data = await response.json();

            // Game Details Section
            let gameDetailsDiv = document.getElementById("game-details");
            gameDetailsDiv.innerHTML = `
                <div class="name">${data.game.details.name}</div>
                <div class="tiles">
                    <div class="container tile flex-r">
                        <img src="/static/assets/people.png" width="20">
                        <div>${data.game.details.minplayers}</div>
                        <div>&nbsp;-&nbsp;</div>
                        <div>${data.game.details.maxplayers}</div>
                    </div>
                    <div class="container tile minage">Min Age: ${data.game.details.minage}</div>
                    <div class="container tile flex-r">
                        <img src="/static/assets/time-left.png" width="20" height="20">
                        <div>${data.game.details.playingtime} min.</div>
                    </div>
                </div>
                <p> Categories: </p>
                <div class="categories">
                    ${data.game.attributes.boardgamecategory.map(category => 
                        `<div class="container category">${category}</div>`
                    ).join("")}
                </div>
                <p> Mechanics: </p>
                <div class="mechanics">
                    ${data.game.attributes.boardgamemechanic.map(mechanic => 
                        `<div class="container mechanic">${mechanic}</div>`
                    ).join("")}
                </div>
                <p> Description: </p>
                <div class="description">${data.game.details.description}</div>
            `;

            // Similar Games Section
            let similarGamesDiv = document.getElementById("similar-games");
            similarGamesDiv.innerHTML = `<div class="name">Similar Games:</div><ul>`;
            data.similar_games.forEach(game => {
                similarGamesDiv.innerHTML += `
                    <li>
                        <a href="/game/${game.details.name}">${game.details.name}</a>
                    </li>`;
            });
            similarGamesDiv.innerHTML += "</ul>";

            let sentimentDiv = document.getElementById("sentiment-analysis");
        if (data.sentiment) {
            sentimentDiv.innerHTML = `
                <h3>Review Sentiment Analysis</h3>
                <div class="sentiment-metric">
                    <div class="metric-label">Overall Polarity:</div>
                    <div class="metric-value">${data.sentiment.average_polarity.toFixed(2)}</div>
                    <div class="polarity-bar">
                        <div class="polarity-fill" style="width: ${(data.sentiment.average_polarity + 1) * 50}%"></div>
                    </div>
                    <div class="metric-explanation">
                        (-1 = Negative, 0 = Neutral, +1 = Positive)
                    </div>
                </div>`;
        } else {
            sentimentDiv.innerHTML = `<p>No sentiment data available (no reviews yet)</p>`;
        }

            // Reviews Section
        let reviewsDiv = document.getElementById("reviews");
        reviewsDiv.innerHTML = `<h3>Player Reviews</h3>`;
        
        if (data.reviews.length > 0) {
            data.reviews.forEach(review => {
                const date = new Date(review.timestamp).toLocaleDateString();
                reviewsDiv.innerHTML += `
                    <div class="review">
                        <div class="review-text">${review.text}</div>
                        <div class="review-sentiment">
                            <div class="review-date">Polarity: ${review.polarity.toFixed(2)}</div>
                            <div class="review-date">Classified as: ${review.classification}</div>
                        </div>
                    </div>`;
            });
        } else {
            reviewsDiv.innerHTML += `<p>No reviews yet. Be the first to share your thoughts!</p>`;
        }

        reviewsDiv.innerHTML += `
            <div class="review-form">
                <textarea id="review-text" placeholder="Write your review..."></textarea>
                <button onclick="submitReview('${data.game.id}')">Submit Review</button>
            </div>`;
    }

        async function submitReview(gameId) {
            const reviewText = document.getElementById("review-text").value.trim();
            if (!reviewText) return;

            try {
                await fetch('/submit_review', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        game_id: gameId,
                        review_text: reviewText
                    })
                });
                document.getElementById("review-text").value = "";
                await loadGameDetails();
            } catch (error) {
                console.error('Error submitting review:', error);
            }
        }

        window.onload = loadGameDetails;
    </script>
</head>
<body>
    <h1 class="title" onclick="window.location.href='/'">Board Game Search</h1>
    <div class="container game noclick" id="game-details"></div>
    <div class="container game noclick" id="sentiment-analysis"></div>
    <div class="container game noclick" id="reviews"></div>
    <div class="container game noclick" id="similar-games"></div>
</body>
</html>